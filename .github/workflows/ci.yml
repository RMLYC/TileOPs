name: CI

permissions:
  contents: write

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * *"

concurrency:
  # Keep only the newest run for the same PR or branch ref.
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  pre-commit:
    if: ${{ github.repository == 'tile-ai/TileOPs' && github.event_name != 'schedule' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Equivalent to GIT_STRATEGY: fetch

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"  # At least 3.9 to avoid pre-commit-hooks reporting Python version too low

      - name: Run pre-commit
        # Official pre-commit Action, automatically:
        # 1) Install pre-commit
        # 2) Generate virtual environment according to .pre-commit-config.yaml configuration
        # 3) Execute pre-commit run
        uses: pre-commit/action@v3.0.1
        with:
          # Run on all files once, and print diff on failure
          extra_args: --all-files --show-diff-on-failure

  packaging:
    if: ${{ github.repository == 'tile-ai/TileOPs' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') }}
    runs-on: [self-hosted, tile-ops, venv]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Create clean virtual environment
        run: |
          set -euo pipefail
          VENV_DIR="tileops_wheel_ci_venv"
          VENV_PATH="${{ runner.tool_cache }}/${VENV_DIR}"
          echo "Preparing clean venv at ${VENV_PATH}"
          rm -rf "${VENV_PATH}"
          python -m venv "${VENV_PATH}"
          # shellcheck source=/dev/null
          source "${VENV_PATH}/bin/activate"
          python -m pip install --upgrade pip setuptools wheel
        shell: bash

      - name: Install required dependencies
        run: |
          set -euo pipefail
          VENV_DIR="tileops_wheel_ci_venv"
          source "${{ runner.tool_cache }}/${VENV_DIR}/bin/activate"
          pip install build pytest
        shell: bash

      - name: Build wheel package
        run: |
          set -euo pipefail
          VENV_DIR="tileops_wheel_ci_venv"
          source "${{ runner.tool_cache }}/${VENV_DIR}/bin/activate"
          python -m build --wheel
          echo "Build artifacts:"
          ls -lh dist/*.whl
        shell: bash

      - name: Run unit tests against built wheel
        run: |
          set -euo pipefail
          VENV_DIR="tileops_wheel_ci_venv"
          source "${{ runner.tool_cache }}/${VENV_DIR}/bin/activate"
          pip install --force-reinstall dist/*.whl

          cat <<'PY' > /tmp/test_tileops_wheel.py
          import importlib.metadata
          from pathlib import Path

          import tileops

          pkg_path = Path(tileops.__file__).resolve()
          print(f"tileops imported from: {pkg_path}")
          assert "site-packages" in str(pkg_path), "tileops is not imported from wheel installation"

          version = importlib.metadata.version("tileops")
          print(f"tileops version: {version}")
          assert version
          PY

          python -m pytest -q /tmp/test_tileops_wheel.py
        shell: bash

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: tileops-wheel-${{ github.sha }}
          path: dist/*.whl
          if-no-files-found: error
          retention-days: 14

      - name: Publish wheel to GitHub Release (tag only)
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.whl
          fail_on_unmatched_files: true

      - name: Cleanup wheel venv
        if: ${{ always() }}
        run: |
          set -euo pipefail
          VENV_DIR="tileops_wheel_ci_venv"
          VENV_PATH="${{ runner.tool_cache }}/${VENV_DIR}"
          echo "Removing venv at: ${VENV_PATH}"
          rm -rf "${VENV_PATH}"
        shell: bash

  tileops_test_release:
    # needs: pre-commit
    if: ${{ github.repository == 'tile-ai/TileOPs' && github.event_name != 'schedule' }}
    runs-on: [self-hosted, tile-ops, venv]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Equivalent to GIT_STRATEGY: fetch

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure persistent venv and install dependencies
        run: |
          set -e
          VENV_DIR="tileops_release_venv"

          echo "Creating fresh venv at ${{ runner.tool_cache }}/${VENV_DIR}"
          rm -rf "${{ runner.tool_cache }}/${VENV_DIR}"
          python -m venv "${{ runner.tool_cache }}/${VENV_DIR}"
          # shellcheck source=/dev/null
          source "${{ runner.tool_cache }}/${VENV_DIR}/bin/activate"
          python -m pip install --upgrade pip setuptools wheel --no-user
          PIP_NO_BUILD_ISOLATION=1 pip install -e '.[dev]'
        shell: bash

      - name: Run tests
        run: |
          VENV_DIR="tileops_release_venv"
          source "${{ runner.tool_cache }}/${VENV_DIR}/bin/activate"
          export PYTHONPATH="$(pwd):$PYTHONPATH"
          echo "PYTHONPATH=$PYTHONPATH"
          set -o pipefail
          python -m pytest -q tests  | tee tileops_test_release.log
        shell: bash

      - name: Cleanup venv
        if: ${{ always() }}
        run: |
          set -e
          VENV_DIR="tileops_release_venv"
          VENV_PATH="${{ runner.tool_cache }}/${VENV_DIR}"
          echo "Removing venv at: ${VENV_PATH}"
          rm -rf "${VENV_PATH}"
        shell: bash

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()  # Equivalent to when: always
        with:
          name: tileops_test_release.log
          path: tileops_test_release.log
          retention-days: 7  # Equivalent to expire_in: 1 week
