name: pr-validation

permissions:
  contents: read

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main
      - dev

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-commits:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Validate commit messages
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          echo "Checking commits from $BASE_SHA to $HEAD_SHA"

          # TileOPs convention: [Type] description  or  [Type][Scope] description
          PATTERN='^\[(Feat|Feature|Fix|BugFix|Refactor|CI|Docs|Test|Build|Chore|Perf|Style|Enhancement|Bench)\](\[[a-zA-Z0-9_-]+\])? .+'

          STATUS=0
          while IFS= read -r COMMIT_SHA; do
            SUBJECT="$(git log -1 --format=%s "$COMMIT_SHA")"
            if [[ ! "$SUBJECT" =~ $PATTERN ]]; then
              echo "::error::Commit $COMMIT_SHA does not follow TileOPs format."
              echo "  Expected: [Type] description  or  [Type][Scope] description"
              echo "  Got: $SUBJECT"
              STATUS=1
            else
              echo "OK: $SUBJECT"
            fi
          done < <(git log --format=%H "${BASE_SHA}..${HEAD_SHA}")

          exit $STATUS

  validate-pr-title:
    runs-on: ubuntu-latest
    if: github.event.action != 'synchronize'
    steps:
      - name: Validate PR title format
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Expected: [Type] description  or  [Type][Scope] description
          # Type: Feat, Feature, Fix, BugFix, Refactor, CI, Docs, Test, Build, Chore, Perf, Style, Enhancement
          PATTERN='^\[(Feat|Feature|Fix|BugFix|Refactor|CI|Docs|Test|Build|Chore|Perf|Style|Enhancement)\](\[[a-zA-Z0-9_-]+\])? .+'
          if [[ ! "$PR_TITLE" =~ $PATTERN ]]; then
            echo "::error::PR title does not follow TileOPs format."
            echo "Expected: [Type] description  or  [Type][Scope] description"
            echo "Types: Feat, Feature, Fix, BugFix, Refactor, CI, Docs, Test, Build, Chore, Perf, Style, Enhancement"
            echo "Got: $PR_TITLE"
            exit 1
          fi
          echo "PR title is valid: $PR_TITLE"
